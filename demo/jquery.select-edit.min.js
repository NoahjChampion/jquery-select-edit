!function(a){"use strict";var b,c="selectEdit",d=27,e=38,f=40,g=39,h=37,i=13,j=a(document),k=a(window),l="select-edit",m=l+"__select",n=m+"_open",o=m+"_empty",p=m+"__current",q=l+"-drop",r=q+"_show-up",s=q+"_show-down",t=q+"_show",u=l+"__tooltip",v=l+"__results",w=l+"__submit-box",x=l+"__submit",y=l+"__search-box",z=l+"__search-input",A=v,B=v+"__item",C=B+"_marked",D=B+"_hover",E=B+"_selected",F=5,G={up:r,down:s},H=Object.prototype.toString,I=function(a){return"function"==typeof a},J=function(a){return"[object String]"==H.call(a)},K=function(a){return"[object Array]"==H.call(a)},L=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b};b=function(b,d){return this.$select=a(b),this.options=d,this.$select.is("select")?(this.$select.attr("autocomplete","off"),this.isMultiple=this.$select.prop("multiple"),this._fixSelect(),void this.initialize()):(console.warn(c,"Sorry, only select element!"),!1)},b.DEFAULTS={tmplContent:'<div role="form"><span role="button"><span role="link"></span></span></div>',tmplGroup:'<div role="group"></div>',tmplTooltip:'<div role="tooltip"></div>',tmplList:'<div role="list"></div>',tmplListbox:'<div role="listbox"></div>',tmplListitem:'<div role="listitem"%attrs%>%text%</div>',tmplSubmitBox:"<div></div>",tmplSubmit:'<button role="actionButton">submit</button>',tmplSearchBox:"<div></div>",tmplSearchInput:'<input name="_search" type="search" />',placeholderTitle:null,appendBody:!1,submitButton:!1,search:null,placeholderSearch:"Search",classHide:l+"-hide",classForm:l,classButton:m,classButtonOpen:n,classButtonEmpty:o,classButtonText:p,classGroup:q,classGroupShow:t,classTooltip:u,classSubmitBox:w,classSubmit:x,classSearchBox:y,classSearchInput:z,classList:v,classListbox:A,classListitem:B,classListitemHover:D,classListitemSelected:E,callItemToggle:null,callBeforeChange:null},b.prototype={Constructor:b,isOpen:!1,isGenerateItems:!1,initialize:function(){var b=this.options;this._initHtml(),this._hideSelect(),this.$select.attr("tabindex","-1").on("change."+c,a.proxy(this._onChangeSelect,this)),this.$fakeInput=a('<input tabindex="0">').addClass(b.classHide).on("focus keydown blur",a.proxy(this._onEventFake,this)).insertBefore(this.$select),this._actualizeButtonText(),this.$content.insertAfter(this.$select),this.$button.on("click."+c+" touchend."+c,a.proxy(this.toggle,this)),this.$submitButton&&this.$submitButton.on("click."+c,a.proxy(this.submitChanges,this)),k.on("resize."+c,this.updateListPosition.bind(this))},destroy:function(){this.hide(),this.$content.remove(),this.$fakeInput.remove(),this._showSelect(),this.$select.data(c,!1),this.$select.off("."+c),k.off("."+c)},_onEventFake:function(a){switch(a.type){case"focus":this.show();break;case"blur":}},_onChangeSelect:function(){return this._actualizeListItems(),this._actualizeButtonText(),!0},_actualizeListItems:function(){var b=this.options.classListitemSelected,c=this.getListItems(),d=this.getSelected(),e={};d.each2(function(){e[this.value]=this}),c.removeClass(b).each2(function(){var c=this.getAttribute("data-value");e[c]&&a(this).addClass(b)})},_actualizeButtonText:function(){var a=this.options.placeholderTitle||this._getSelectedText();this.$buttonText.text(a||this.$select.attr("placeholder")),this.$button.toggleClass(this.options.classButtonEmpty,!a)},toggle:function(){return this.isOpen?this.hide():this.show(),!1},submitChanges:function(){var b=this.getMarkedOptions();b.each(function(b,c){var d=a(c),e=d.data("value"),f=d.hasClass(this.options.classListitemSelected);d.removeClass(C),setTimeout(this._switchOption.bind(this,e,f)),this._actualizeButtonText(),this.hide()}.bind(this))},updateListPosition:function(){var a=this.$content.offset(),b=this.$group.outerHeight(),c=k.height(),d=this.$content.outerHeight(),e=k.scrollTop(),f=c-a.top-d-F,g=0,h="",i=a.top-e>b,j=f>b;!j&&i?(g=-b-F,h="up"):(g=d+F,h="down"),this.options.appendBody&&(a.top+=g,this.$group.offset(a)),this.setMod(h,G,this.$group)},setMod:function(a,b,c){this.removeModElement(c,b).addClass(b[a])},removeModElement:function(a,b){return a.removeClass(L(b).join(" "))},show:function(){return this.isOpen?!0:(j.trigger("event-show."+c),this._generateItems(),this.$group.addClass(this.options.classGroupShow).appendTo(this.options.appendBody&&document.body||this.$content).focus(),this.$searchInput&&this.$searchInput.focus(),this.updateListPosition(),this.isOpen=!0,void this._eventsGroup())},hide:function(){this.isOpen=!1,this._eventsGroup(),this.$group.removeClass(this.options.classGroupShow),this.options.appendBody&&this.$group.offset({top:0,left:0}),this.$group.detach()},_eventsGroup:function(){var b=this.options,d=this.$searchInput;this.isOpen?(this.$group.on("touchmove."+c,a.proxy(this._touchmoveGroup,this)).on("click."+c+" touchend."+c,a.proxy(this._clickGroup,this)).on("click."+c+" touchend."+c,"."+b.classListitem,a.proxy(this._clickListItem,this)).on("mouseover."+c+" mouseout."+c+" touchend."+c,"."+b.classListitem,a.proxy(this._hoverItem,this)),j.on("keydown."+c,a.proxy(this._keydownGroup,this)).on("click."+c+" touchend."+c,a.proxy(this._clickDocument,this)).on("event-show."+c,a.proxy(this.hide,this)),d&&d.on("keyup."+c,a.proxy(this._searchItems,this))):(this.$group.off("."+c),j.off("."+c),d.off("."+c)),this.toggleButton()},toggleButton:function(){this.$button.toggleClass(this.options.classButtonOpen,this.isOpen)},_keydownGroup:function(a){var b=this.options;if(!this.isOpen)return!0;switch(a.which){case f:case e:return this._navGroupItem(a.which===f),!1;case g:case h:return this._navGroupItem(a.which===g),!1;case d:this.hide();break;case i:this._toggleListItemHover(),!this.isMultiple&&!b.submitButton&&this.hide()}},_navGroupItem:function(a){var b,c,d,e,f=this.options,g=f.classListitemHover,h=this.getListItems(),i=this._getListItemsHover(h);a?(b=i.length&&i.nextAll(":not(:hidden):first"),b=b.length&&b||h.filter(":not(:hidden):first")):(b=i.length&&i.prevAll(":not(:hidden):first"),b=b.length&&b||h.filter(":not(:hidden):last")),c=this.$list.height(),d=this.$list.scrollTop(),e=b.position(),e=e.top,c<e+b.outerHeight()?this.$list.scrollTop(d+(e+b.outerHeight()-c)):0>e&&this.$list.scrollTop(d+e),i.removeClass(g),b.addClass(g)},_clickGroup:function(){return!1},_clickDocument:function(){this.hide()},_toggleListItemHover:function(){var a=this._getListItemsHover();a.length&&this._switchListItem(a,!a.hasClass(this.options.classListitemSelected))},_hoverItem:function(b){var c=this.getListItems(),d=this.options.classListitemHover,e=a(b.currentTarget);switch(b.type){case"mouseover":case"touchend":"touchend"===b.type&&c.removeClass(d),e.addClass(d);break;case"mouseout":c.removeClass(d)}},_touchmoveGroup:function(){this.isTouchMove=!0},_clickListItem:function(b){if(this.isTouchMove)return this.isTouchMove=!1,!0;var c=this.options,d=c.classListitemSelected,e=a(b.currentTarget),f=!e.hasClass(d);this.isMultiple||c.submitButton||(this.getListItems().removeClass(d),this.hide()),this._switchListItem(e,f)},_switchListItem:function(a,b){var c=this.options,d=this.options.callBeforeChange,e=!0,f=a.data("value"),g={value:f,selected:b};return I(d)&&(e=d(g)),this.$select.trigger("beforeChange",g),e?(this.isMultiple||a.siblings().removeClass(c.classListitemSelected),a.toggleClass(c.classListitemSelected,b),this.options.submitButton?void a.addClass(C):(this._switchOption(a.data("value"),b),void this._actualizeButtonText())):!1},_switchOption:function(a,b){var c=this.$select.find('option[value="'+a+'"]'),d=this.options.callItemToggle,e={value:a,selected:b};c.prop("selected",b),!b&&c.removeAttr("selected"),I(d)&&d(e),this.$select.trigger("change").trigger("itemToggle",e)},getListItems:function(){return this.$listItems||a()},_getListItemsHover:function(a){return a=a||this.getListItems(),a.filter("."+this.options.classListitemHover)},_getSelectedText:function(){var b="";return this.getSelected().each(function(){b+=(b?", ":"")+a(this).text()}),b},getSelected:function(){var b=this.$select.val(),c=a();if(J(b))c=this.$select.find('[value="'+b+'"]');else if(K(b)){var d=this.$select.find("[value]");b.forEach(function(a){var b=d.filter('[value="'+a+'"]');c=c&&c.add(b)||b})}return c},getMarkedOptions:function(){return this.$list.find("."+C)},_hideSelect:function(){this.$select.addClass(this.options.classHide)},_showSelect:function(){this.$select.removeClass(this.options.classHide)},_searchItems:function(b){var c=a(b.currentTarget),d=c.val();return c.data("lastSearch")===d?!1:(c.data("lastSearch",d),void this.$listItems.each2(function(a,b){var c=b[0],e=c.innerHTML;c.style.display=~e.search(new RegExp(d,"i"))?"":"none"}))},_initHtml:function(){var b=this.options;this.$content=a(b.tmplContent).addClass(b.classForm),this.$button=this.$content.find("[role=button]").addClass(b.classButton),this.$buttonText=this.$content.find("[role=link]").addClass(b.classButtonText),this.$group=a(b.tmplGroup).addClass(b.classGroup),this.$list=this.isMultiple?a(b.tmplListbox).addClass(b.classListbox):a(b.tmplList).addClass(b.classList),this.$listItem=a(b.tmplListitem).addClass(b.classListitem),this.$listItems=a(),this.options.tooltip&&(this.$tooltip=a(b.tmplTooltip).addClass(b.classTooltip).html(this.options.tooltip),this.$group.append(this.$tooltip)),this.$group.append(this.$list),b.submitButton&&(this.$submitBox=a(b.tmplSubmitBox).addClass(b.classSubmitBox),this.$submitButton=a(b.tmplSubmit).addClass(b.classSubmit),this.$submitBox.append(this.$submitButton).appendTo(this.$group))},_generateItems:function(){if(this.isGenerateItems)return!0;var b,c=this.options,d=(a(),this.$listItem),e=d[0],f="",g=document.createElement("div"),h=this.$select.contents("option");g.appendChild(e),b=g.innerHTML,h.each2(function(){var a=this.innerHTML,c=this.value,d=b;return a?(d=d.replace("%attrs%",' data-value="'+c+'"'),d=d.replace("%text%",a),void(f+=d)):!0}),(c.placeholderSearch||c.search||null===c.search&&h.length>10)&&!this.$searchInput&&(this.$searchBox=a(c.tmplSearchBox).addClass(c.classSearchBox),this.$searchInput=a(c.tmplSearchInput).addClass(c.classSearchInput).attr("placeholder",c.placeholderSearch),this.$searchBox.append(this.$searchInput).insertBefore(this.$list)),this.$listItems=a(f),this.$list.html(this.$listItems),this._actualizeListItems(),this.isGenerateItems=!0},_fixSelect:function(){var a=this.$select.find(":not([value])");a.length||this.isMultiple||this.$select.prepend('<option selected="selected"></option>')}},a.fn[c]=function(d){return this.each(function(){var e=a(this),f=e.data(),g=e.data(c),h=a.extend({},b.DEFAULTS,f,"object"==typeof d&&d);g||e.data(c,g=new b(this,h)),"string"==typeof d&&I(g[d])&&("_"!==d.charAt(0)?g[d]():console.warn(c,"Do not use private methods!"))})},a.fn[c].Constructor=b,Array.prototype.forEach||(Array.prototype.forEach=function(a,b){for(var c=0,d=this.length;d>c;++c)a.call(b,this[c],c,this)}),"undefined"==typeof a.fn.each2&&a.extend(a.fn,{each2:function(b){for(var c=a([0]),d=-1,e=this.length;++d<e&&(c.context=c[0]=this[d])&&b.call(c[0],d,c)!==!1;);return this}})}(jQuery);